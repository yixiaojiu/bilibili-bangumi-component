const isMock = false
function p(e){return Object.entries(e).filter(([,s])=>!!s).map(([s,t])=>`${s}=${t}`).join("&")}function d(e){return Object.fromEntries(Array.from(e.searchParams.entries()).filter(([,s])=>!!s))}function m(e){let s=e.toString();if(s.length<5)return s;if(s.length<9){let o=s.slice(0,-3),n=o.length,i=o[n-1]==="0"?"":`.${o[n-1]}`;return`${o.slice(0,n-1)}${i}\u4E07`}let t=s.slice(0,-7),r=t.length,a=t[r-1]==="0"?"":`.${t[r-1]}`;return`${t.slice(0,r-1)}${a}\u4EBF`}function c(e){return Response.json(e,{status:e.code})}var j={1:"anime",2:"game",3:"book",4:"music",5:"real"},v={1:"want",2:"doing",3:"done"};function h(e,s){let{subjectType:t="1",collectionType:r="0",pageNumber:a=1,pageSize:o=10}=e,n=s[j[t]];if(!n)return b(o);let i;if(r!=="0"){let l=n[v[r]];if(!l||!l.length)return b(o);i=l}else{let l=Object.values(n).flat();if(!l.length)return b(o);i=l}return c({code:200,message:"ok",data:{list:i.slice((a-1)*o,a*o),pageNumber:a,pageSize:o,total:i.length,totalPages:Math.ceil(i.length/o)}})}function b(e){return c({code:200,message:"ok",data:{list:[],pageNumber:1,pageSize:e,total:0,totalPages:1}})}async function y(e,s){let{collectionType:t="0",uid:r,pageNumber:a="1",pageSize:o="10"}=e,n=r??s?.BILIBILI;if(!n)return c({code:400,message:"uid is required",data:{}});let i=p({type:1,follow_status:t,pn:a,ps:o,vmid:n}),l=await fetch(`https://api.bilibili.com/x/space/bangumi/follow/list?${i}`),u=await l.json();return!l.ok||u?.code!==0?c({code:502,message:u.message,data:{}}):c({code:200,message:"ok",data:x(u.data)})}function x(e){return{list:e?.list?.map(t=>{let r=[{label:t?.new_ep?.index_show},{label:"\u8BC4\u5206",value:t?.rating?.score},{label:"\u64AD\u653E\u91CF",value:t?.stat?.view&&m(t.stat.view)},{label:"\u8FFD\u756A\u6570",value:t?.stat?.follow&&m(t.stat.follow)},{label:"\u6295\u5E01\u6570",value:t?.stat?.coin&&m(t.stat.coin)},{label:"\u5F39\u5E55\u6570",value:t?.stat?.danmaku&&m(t.stat.danmaku)}],a=t.cover;if(a&&a.startsWith("http:")){let o=new URL(a);o.protocol="https:",a=o.toString()}return{nameCN:t.title,summary:t.summary,cover:a,url:t.url,labels:r.filter(o=>o.label)}})??[],pageNumber:e.pn,pageSize:e.ps,total:e.total,totalPages:Math.ceil(e.total/e.ps)}}var N={1:"2",2:"4",3:"1",4:"3",5:"6"},w={0:null,1:"1",2:"3",3:"2",4:"4",5:"5"};async function S(e,s){let{subjectType:t="1",uid:r,collectionType:a="0",pageNumber:o=1,pageSize:n=10}=e,i=r??s?.BGM;if(!i)return c({code:400,message:"uid is required",data:{}});let l=p({subject_type:N[t],type:w[a],limit:n,offset:(Number(o)-1)*Number(n)}),u=await fetch(`https://api.bgm.tv/v0/users/${i}/collections?${l}`,{headers:{"User-Agent":"yixiaojiu/bilibili-bangumi-component (https://github.com/yixiaojiu/bilibili-bangumi-component)"}}),f=await u.json();return u.ok?c({code:200,message:"ok",data:L(f,{pageNumber:Number(o),pageSize:Number(n)})}):c({code:502,message:f.description,data:{}})}function L(e,s){return{list:e?.data?.map(r=>{let a=r?.subject,o=[{label:a?.eps&&`${a.eps}\u8BDD`},{label:"\u8BC4\u5206",value:a?.score},{label:"\u6392\u540D",value:a?.rank},{label:"\u65F6\u95F4",value:a?.date}];return{name:a?.name,nameCN:a?.name_cn,summary:a?.short_summary,cover:a?.images?.large,url:a?.id?`https://bgm.tv/subject/${a?.id}`:"https://bgm.tv/",labels:o.filter(n=>"value"in n?n.value:n.label)}})??[],...s,total:e.total,totalPages:Math.ceil(e.total/s.pageSize)}}function R(e){let{pageNumber:s=1,pageSize:t=10}=e;return{...e,pageNumber:Number(s),pageSize:Number(t)}}function g(e){return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Max-Age","86400"),e}var F={async fetch(e,s){let t=new URL(e.url),r=R(d(t)),a={};try{a=customData}catch{}return t.pathname.endsWith("bilibili")?g(await y(r,s)):t.pathname.endsWith("bgm")?g(await S(r,s)):t.pathname.endsWith("custom")?g(h(r,a)):Response.json({code:404,message:"not found",data:{}},{status:404})}};export{F as default};
