const isMock = false
function p(t){return Object.entries(t).filter(([,a])=>!!a).map(([a,e])=>`${a}=${e}`).join("&")}function f(t){return Object.fromEntries(Array.from(t.searchParams.entries()).filter(([,a])=>!!a))}function m(t){let a=t.toString();if(a.length<5)return a;if(a.length<9){let n=a.slice(0,-3),r=n.length,i=n[r-1]==="0"?"":`.${n[r-1]}`;return`${n.slice(0,r-1)}${i}\u4E07`}let e=a.slice(0,-7),o=e.length,s=e[o-1]==="0"?"":`.${e[o-1]}`;return`${e.slice(0,o-1)}${s}\u4EBF`}function c(t){return Response.json(t,{status:t.code})}var j={1:"anime",2:"game",3:"book"},v={1:"want",2:"doing",3:"done"};function d(t,a){let{subjectType:e="1",collectionType:o="0",pageNumber:s=1,pageSize:n=10}=t,r=a[j[e]];if(!r)return b(n);let i;if(o!=="0"){let l=r[v[o]];if(!l||!l.length)return b(n);i=l}else{let l=Object.values(r).flat();if(!l.length)return b(n);i=l}return c({code:200,message:"ok",data:{list:i.slice((s-1)*n,s*n),pageNumber:s,pageSize:n,total:i.length,totalPages:Math.ceil(i.length/n)}})}function b(t){return c({code:200,message:"ok",data:{list:[],pageNumber:1,pageSize:t,total:0,totalPages:1}})}async function h(t,a){let{collectionType:e="0",uid:o,pageNumber:s="1",pageSize:n="10"}=t,r=o??a?.BILIBILI;if(!r)return c({code:400,message:"uid is required",data:{}});let i=p({type:1,follow_status:e,pn:s,ps:n,vmid:r}),l=await fetch(`https://api.bilibili.com/x/space/bangumi/follow/list?${i}`),u=await l.json();return!l.ok||u?.code!==0?c({code:502,message:u.message,data:{}}):c({code:200,message:"ok",data:x(u.data)})}function x(t){return{list:t?.list?.map(e=>{let o=[{label:e?.new_ep?.index_show},{label:"\u8BC4\u5206",value:e?.rating?.score},{label:"\u64AD\u653E\u91CF",value:e?.stat?.view&&m(e.stat.view)},{label:"\u8FFD\u756A\u6570",value:e?.stat?.follow&&m(e.stat.follow)},{label:"\u6295\u5E01\u6570",value:e?.stat?.coin&&m(e.stat.coin)},{label:"\u5F39\u5E55\u6570",value:e?.stat?.danmaku&&m(e.stat.danmaku)}];return{nameCN:e.title,summary:e.summary,cover:e.cover,url:e.url,labels:o.filter(s=>s.label)}})??[],pageNumber:t.pn,pageSize:t.ps,total:t.total,totalPages:Math.ceil(t.total/t.ps)}}var R={1:"2",2:"4",3:"1"},N={0:null,1:"1",2:"3",3:"2"};async function y(t,a){let{subjectType:e="1",uid:o,collectionType:s="0",pageNumber:n=1,pageSize:r=10}=t,i=o??a?.BGM;if(!i)return c({code:400,message:"uid is required",data:{}});let l=p({subject_type:R[e],type:N[s],limit:r,offset:(Number(n)-1)*Number(r)}),u=await fetch(`https://api.bgm.tv/v0/users/${i}/collections?${l}`,{headers:{"User-Agent":"yixiaojiu/bilibili-bangumi-component (https://github.com/yixiaojiu/bilibili-bangumi-component)"}}),g=await u.json();return u.ok?c({code:200,message:"ok",data:T(g,{pageNumber:Number(n),pageSize:Number(r)})}):c({code:502,message:g.description,data:{}})}function T(t,a){return{list:t?.data?.map(o=>{let s=o?.subject,n=[{label:s?.eps&&`${s.eps}\u8BDD`},{label:"\u8BC4\u5206",value:s?.score},{label:"\u6392\u540D",value:s?.rank},{label:"\u65F6\u95F4",value:s?.date}];return{name:s?.name,nameCN:s?.name_cn,summary:s?.short_summary,cover:s?.images?.large,url:s?.id?`https://bgm.tv/subject/${s?.id}`:"https://bgm.tv/",labels:n.filter(r=>"value"in r?r.value:r.label)}})??[],...a,total:t.total,totalPages:Math.ceil(t.total/a.pageSize)}}function S(t){let{pageNumber:a=1,pageSize:e=10}=t;return{...t,pageNumber:Number(a),pageSize:Number(e)}}var F="edge",G=["hkg1","hnd1","kix1","sin1"];async function H(t){let a=new URL(t.url),e=S(f(a));if(isMock){if(a.pathname.endsWith("bilibili"))return Response.json(mockDataMap.bilibili);if(a.pathname.endsWith("bgm"))return Response.json(mockDataMap.bgm)}let o={};try{o=customData}catch{}return a.pathname.endsWith("bilibili")?await h(e,process.env):a.pathname.endsWith("bgm")?await y(e,process.env):a.pathname.endsWith("custom")?d(e,o):Response.json({code:404,message:"not found",data:{}},{status:404})}export{H as GET,G as preferredRegion,F as runtime};
